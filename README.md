# ДЗ 10 Отказоустойчивость приложений

#### Highloaded Social Network

## Запускаем проект через докер
- скачиваем исходники git checkout
- заходим в корень проекта
- запускаем docker-compose up
- докер скачивает образы Postgres, Maven, Java-17, билдит артефакты Springboot приложений и запускает их. Иногда наблюдается запуск не всех трех инстансов, в таком случае нужно немного подождать и вручную перезапустить незапущенный инстанс. Данная аномалия случается из-за того, что кластерная версия БД во время запуска не всегда отвечает инстансам приложения.
- по адресу localost (80-й порт) NGINX перенаправляет все запросы /app на приложение с реврайтом URL (/app убирается)

## Что сделано согласно заданию (кратко)
- подняты мастер и 3 реплики Postgre SQL. Контейнеры pgslave-1, pgslave-2 и pgslave-3
- соединение со репликами реализовано через haproxy. Чтение профайлов юзеров, что использууется в нагрузочном тестировании организовано именно с реплик.
- подняты три инстанса приложения app-core-1, app-core-2, app-core-2
- под нагрузкой убита реплика БД pg-slave-3, проверено, что приложение работает дальше, наблюдался кратковременный всплеск Error Rate меньше чем 1%
- под нагрузкой убит инстанс приложения app-core-2, проверено, что приложение работает дальше, наблюдался кратковременный всплеск Error Rate и сильный всплеск Avg Response Time

## Отчет (подробно)
- конфигурация haproxy использованная в докер контейнере - ```./haproxy/haproxy.cfg```
- конфигураци nginx  использованная в докер контейнере - ```./nginx/default.conf```
- запросы для регистрации двух пользователей в postman collection ```./hw-10_report/01_prepare_users.postman.collection.json```
- запросы профайлов пользователей, использованные при нагрузочном тестировании в postman collection ```./hw-10_report/02_load_tests.postman.collection.json```
- логи приложений app-core также можно найти в файлах app-core-.... в ```./hw-10_report/app-core-*``` Логи малоинформативны. В логах есть старт приложений и кусок лога скопированный из консоли докера в конце тестов, там можно посмотреть на ошибки. Успешные запросы в логах не отображаются.
- в ```./hw-10_report/``` также находятся 20 скриншотов, использованных далее в данном отчете

00. Список всех запущенных докер контейнеров перед запуском нагрузки
![](hw-10_report/00.jpg)
01. Убеждаемся, что кластер стартовал корректно и Postgres реплики присоединены к мастеру
![](hw-10_report/01.jpg)
02. Убеждаемся, что HAPROXY видит все 3 реплики и реплики активны
![](hw-10_report/02.jpg)
03. Убеждаемся, что в NGINX ошибок нет
![](hw-10_report/03.jpg)
04. Смотрим CPU инстансов приложения без нагрузки
![](hw-10_report/04.jpg)
05. Смотрим CPU реплик БД без нагрузки
![](hw-10_report/05.jpg)
06. Конфигурируем нагрузку - запустим Postman Collection в режиме Perfomance 
![](hw-10_report/06.jpg)
07. Запустили нагрузку, наблюдаем ее возрастание и отсутствие ошиок
![](hw-10_report/07.jpg)
08. Смотрим CPU инстансов приложения под нагрузкой - распределяется равномерно на все три инстанса
![](hw-10_report/08.jpg)
09. Смотрим CPU реплик БД под нагрузкой. На двух скриншотах видно, что в начале нагрузка распределялось равномерно, как на первом скриншоте. Но потом начала сильно прыгать по инстансам. Это видно на втором скриншоте
![](hw-10_report/09.jpg)
10. Смотрим CPU реплик БД под нагрузкой. Нагрузка прыгает
![](hw-10_report/10.jpg)
11. Убиваем реплику pgslave-3
![](hw-10_report/11.jpg)
12. Смотрим CPU реплик БД под нагрузкой. У pgslave-3 CPU 0%
![](hw-10_report/12.jpg)
13. Убеждаемся, что приложение продолжает работу, наблюдался кратковременный всплеск ошибок меньше 1%
![](hw-10_report/13.jpg)
14. Смотрим CPU реплик БД под нагрузкой. Убеждаемся, что pgslave-3 CPU 0% не оживает 
![](hw-10_report/14.jpg)
15. Убиваем инстанс приложения app-core-2
![](hw-10_report/15.jpg)
16. Убеждаемся, что приложение продолжает работу. Наблюдался всплеск ошибок и резкий всплеск Avg Response Time
![](hw-10_report/16.jpg)
17. Смотрим CPU инстансов приложения под нагрузкой - у app-core-2 CPU 0%
![](hw-10_report/17.jpg)
18. Наблюдаем за приложением - работа стабилизировалась. С двумя инстансами приложения и двумя репликами БД ошибок нет
![](hw-10_report/18.jpg)
19. Завершение теста. В таблице снизу видно распределение по запросам показателей RPC, Avg Response Time (Latency), Error rate % 
![](hw-10_report/19.jpg)
20. В докере после завершения теста видим, что в процессах нет pgslave-3 и app-core-2
![](hw-10_report/20.jpg)

## Использованы запросы приложения
- регистрация: 
```
POST http://localhost:80/app/user/register
{
        "email": "new2@new.ru",
        "firstName": "new2",
        "password": "new2"
}
```
- обновление профайла
```
POST http://localhost:80/app//user/update
{
    "birthdate": "2017-02-03",
    "gender": "F",
    "biography": "tatata"
}
```
- просмотр профайла (на основе этого запроса проводилось нагрузочное тестирование)
```
GET http://localhost:80/app//user/get/6debd3b1-3083-4c41-b404-780b8d7dc904
```